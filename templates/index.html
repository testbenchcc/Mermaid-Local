<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Mermaid Studio</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <header>
        <h1>Local Mermaid Studio</h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button id="new-btn">New Diagram</button>
            <button id="save-btn">Save Diagram</button>
            <button id="load-btn">Load Diagram</button>
            <div class="theme-switch">
                <span class="theme-switch-label">Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </header>
    <div class="container">
        <!-- Hidden input to store the current diagram ID -->
        <input type="hidden" id="diagram-id" value="">
        <div class="editor-pane">
            <textarea id="editor">Loading...</textarea>
            <div class="controls">
                <button onclick="render()" id="render-btn">Manual Render</button>
                <div class="auto-render">
                    <label for="auto-render-toggle">Auto Render</label>
                    <input type="checkbox" id="auto-render-toggle" checked>
                </div>
            </div>
        </div>
        <div class="resizer" id="divider"></div>
        <div class="preview-pane">
            <div id="preview"></div>
        </div>
    </div>

    <script src="/static/mermaid.min.js"></script>
    <script>
        // Initialize mermaid when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check for saved theme preference or respect OS preference
            const savedTheme = localStorage.getItem('theme') || 
                (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            
            // Apply the theme
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-toggle').checked = savedTheme === 'dark';
            
            // Initialize mermaid with the appropriate theme
            try {
                mermaid.initialize({ 
                    startOnLoad: false,
                    theme: savedTheme === 'dark' ? 'dark' : 'default',
                    securityLevel: 'loose'
                });
                render(); // Initial render
            } catch (error) {
                console.error('Error initializing Mermaid:', error);
                document.getElementById('preview').innerHTML = '<p style="color:red">Failed to initialize Mermaid library</p>';
            }
            
            // Initialize the resizable divider
            initResizer();
            
            // Theme toggle functionality
            document.getElementById('theme-toggle').addEventListener('change', function() {
                const theme = this.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                // Update mermaid theme and re-render
                mermaid.initialize({ 
                    startOnLoad: false,
                    theme: theme === 'dark' ? 'dark' : 'default',
                    securityLevel: 'loose'
                });
                render();
            });
            
            // Setup auto-render functionality
            const editor = document.getElementById('editor');
            const autoRenderToggle = document.getElementById('auto-render-toggle');
            
            // Load saved auto-render preference
            const savedAutoRender = localStorage.getItem('autoRender');
            if (savedAutoRender !== null) {
                autoRenderToggle.checked = savedAutoRender === 'true';
            }
            
            // Add event listener for editor changes
            let debounceTimer;
            editor.addEventListener('input', function() {
                if (autoRenderToggle.checked) {
                    // Debounce the render function to avoid excessive rendering
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(function() {
                        render();
                    }, 500); // Wait 500ms after typing stops
                }
            });
            
            // Save auto-render preference when changed
            autoRenderToggle.addEventListener('change', function() {
                localStorage.setItem('autoRender', this.checked);
                if (this.checked) {
                    render(); // Render immediately when auto-render is turned on
                }
            });
        });

        function render() {
            const code = document.getElementById('editor').value;
            const preview = document.getElementById('preview');
            
            // Clear previous content
            preview.innerHTML = '';
            
            // Create mermaid element
            const mermaidDiv = document.createElement('div');
            mermaidDiv.className = 'mermaid';
            mermaidDiv.textContent = code;
            
            preview.appendChild(mermaidDiv);
            
            try {
                // Render diagram
                mermaid.init(undefined, '.mermaid');
            } catch (error) {
                preview.innerHTML = `<p style="color:red">Error rendering diagram: ${error.message}</p>`;
            }
        }
        
        // Diagram storage functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Modal elements
            const saveModal = document.getElementById('save-modal');
            const loadModal = document.getElementById('load-modal');
            const saveBtn = document.getElementById('save-btn');
            const loadBtn = document.getElementById('load-btn');
            const newBtn = document.getElementById('new-btn');
            const saveClose = document.getElementById('save-close');
            const loadClose = document.getElementById('load-close');
            const saveDiagramBtn = document.getElementById('save-diagram-btn');
            const refreshListBtn = document.getElementById('refresh-list-btn');
            const searchBtn = document.getElementById('search-btn');
            const diagramList = document.getElementById('diagram-list');
            
            // New diagram button - clear editor and reset diagram ID
            newBtn.addEventListener('click', function() {
                document.getElementById('editor').value = '';
                document.getElementById('diagram-id').value = '';
                render();
                alert('New diagram created! You can now edit and save it with a new name.');
            });
            
            // Open save modal
            saveBtn.addEventListener('click', function() {
                const diagramId = document.getElementById('diagram-id').value;
                if (diagramId) {
                    // If we're editing an existing diagram, pre-fill the form
                    fetch(`/api/diagrams/${diagramId}`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('diagram-title').value = data.title;
                            document.getElementById('diagram-tags').value = data.tags || '';
                        })
                        .catch(error => console.error('Error fetching diagram:', error));
                } else {
                    // Clear form for new diagram
                    document.getElementById('diagram-title').value = '';
                    document.getElementById('diagram-tags').value = '';
                }
                saveModal.style.display = 'block';
            });
            
            // Open load modal and load diagrams
            loadBtn.addEventListener('click', function() {
                loadModal.style.display = 'block';
                loadDiagrams();
            });
            
            // Close modals
            saveClose.addEventListener('click', function() {
                saveModal.style.display = 'none';
            });
            
            loadClose.addEventListener('click', function() {
                loadModal.style.display = 'none';
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === saveModal) {
                    saveModal.style.display = 'none';
                }
                if (event.target === loadModal) {
                    loadModal.style.display = 'none';
                }
            });
            
            // Save diagram
            saveDiagramBtn.addEventListener('click', function() {
                console.log('Save button clicked');
                const title = document.getElementById('diagram-title').value;
                const content = document.getElementById('editor').value;
                const tags = document.getElementById('diagram-tags').value;
                const diagramId = document.getElementById('diagram-id').value;
                
                console.log('Diagram data:', { title, content: content.substring(0, 20) + '...', tags, diagramId });
                
                if (!title) {
                    alert('Please enter a title for your diagram');
                    return;
                }
                
                const diagramData = {
                    title: title,
                    content: content,
                    tags: tags
                };
                
                const url = diagramId ? `/api/diagrams/${diagramId}` : '/api/diagrams';
                const method = diagramId ? 'PUT' : 'POST';
                
                console.log('Sending request to:', url, 'with method:', method);
                
                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(diagramData)
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Failed to save diagram');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Save successful, received data:', data);
                    document.getElementById('diagram-id').value = data.id;
                    saveModal.style.display = 'none';
                    alert('Diagram saved successfully!');
                })
                .catch(error => {
                    console.error('Error saving diagram:', error);
                    alert('Failed to save diagram: ' + error.message);
                });
            });
            
            // Load diagrams
            function loadDiagrams() {
                fetch('/api/diagrams')
                    .then(response => response.json())
                    .then(data => {
                        renderDiagramList(data);
                    })
                    .catch(error => {
                        console.error('Error loading diagrams:', error);
                        diagramList.innerHTML = '<p>Error loading diagrams</p>';
                    });
            }
            
            // Search diagrams
            searchBtn.addEventListener('click', function() {
                const query = document.getElementById('search-input').value;
                if (query) {
                    fetch(`/api/diagrams/search/${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            renderDiagramList(data);
                        })
                        .catch(error => {
                            console.error('Error searching diagrams:', error);
                            diagramList.innerHTML = '<p>Error searching diagrams</p>';
                        });
                } else {
                    loadDiagrams();
                }
            });
            
            // Refresh diagram list
            refreshListBtn.addEventListener('click', loadDiagrams);
            
            // Render diagram list
            function renderDiagramList(diagrams) {
                diagramList.innerHTML = '';
                
                if (diagrams.length === 0) {
                    diagramList.innerHTML = '<p style="padding: 10px;">No diagrams found</p>';
                    return;
                }
                
                diagrams.forEach(diagram => {
                    const item = document.createElement('div');
                    item.className = 'diagram-item';
                    item.dataset.id = diagram.id;
                    item.dataset.content = diagram.content;
                    
                    const title = document.createElement('div');
                    title.className = 'title';
                    title.textContent = diagram.title;
                    
                    const meta = document.createElement('div');
                    meta.className = 'meta';
                    const date = new Date(diagram.updated_at);
                    meta.textContent = `Updated: ${date.toLocaleString()}`;
                    
                    item.appendChild(title);
                    item.appendChild(meta);
                    
                    if (diagram.tags) {
                        const tagsContainer = document.createElement('div');
                        tagsContainer.className = 'tags';
                        
                        const tags = diagram.tags.split(',').map(tag => tag.trim());
                        tags.forEach(tag => {
                            if (tag) {
                                const tagSpan = document.createElement('span');
                                tagSpan.className = 'tag';
                                tagSpan.textContent = tag;
                                tagsContainer.appendChild(tagSpan);
                            }
                        });
                        
                        item.appendChild(tagsContainer);
                    }
                    
                    // Load diagram when clicked
                    item.addEventListener('click', function() {
                        document.getElementById('editor').value = this.dataset.content;
                        document.getElementById('diagram-id').value = this.dataset.id;
                        render();
                        loadModal.style.display = 'none';
                    });
                    
                    diagramList.appendChild(item);
                });
            }
            
            // Search on enter key
            document.getElementById('search-input').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    searchBtn.click();
                }
            });
        });
        
        // Initialize resizable divider functionality
        function initResizer() {
            const divider = document.getElementById('divider');
            const editorPane = document.querySelector('.editor-pane');
            const previewPane = document.querySelector('.preview-pane');
            const container = document.querySelector('.container');
            
            // Load saved panel sizes if available
            const savedEditorWidth = localStorage.getItem('editorWidth');
            if (savedEditorWidth) {
                editorPane.style.width = savedEditorWidth;
                previewPane.style.width = `calc(100% - ${savedEditorWidth} - 10px)`; // 10px is the divider width
            }
            
            let isResizing = false;
            
            divider.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault(); // Prevent text selection during drag
            });
            
            function handleMouseMove(e) {
                if (!isResizing) return;
                
                const containerRect = container.getBoundingClientRect();
                const containerWidth = containerRect.width;
                const mouseX = e.clientX - containerRect.left;
                
                // Calculate percentages (min 20%, max 80%)
                const editorPercent = Math.min(Math.max((mouseX / containerWidth) * 100, 20), 80);
                const editorWidth = `${editorPercent}%`;
                const previewWidth = `${100 - editorPercent - 1}%`; // 1% for the divider
                
                editorPane.style.width = editorWidth;
                previewPane.style.width = previewWidth;
                
                // Save the current sizes
                localStorage.setItem('editorWidth', editorWidth);
            }
            
            function stopResize() {
                isResizing = false;
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', stopResize);
                
                // Re-render the diagram to fit the new container size
                render();
            }
        }
    </script>
    <!-- Save Diagram Modal -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-btn" id="save-close">&times;</span>
                <h2>Save Diagram</h2>
            </div>
            <div class="form-group">
                <label for="diagram-title">Title:</label>
                <input type="text" id="diagram-title" class="form-control" placeholder="Enter a title for your diagram">
            </div>
            <div class="form-group">
                <label for="diagram-tags">Tags (comma separated):</label>
                <input type="text" id="diagram-tags" class="form-control" placeholder="tag1, tag2, tag3">
            </div>
            <!-- diagram-id is defined in the main container -->
            <div class="modal-footer">
                <button id="save-diagram-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Load Diagram Modal -->
    <div id="load-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-btn" id="load-close">&times;</span>
                <h2>Load Diagram</h2>
            </div>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search diagrams...">
                <button id="search-btn">Search</button>
            </div>
            <div class="diagram-list" id="diagram-list">
                <!-- Diagram items will be populated here -->
            </div>
            <div class="modal-footer">
                <button id="refresh-list-btn">Refresh List</button>
            </div>
        </div>
    </div>
</body>
</html>
